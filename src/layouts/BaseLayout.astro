---
// BaseLayout: Tailwind + local fonts + no Font Awesome
import '../styles/tailwind.css';
import '@fontsource-variable/geist';
import '@fontsource-variable/space-grotesk';

import Navbar from '../components/Navbar.astro';
import Footer from '../components/Footer.astro';

export interface Props {
  title?: string;
  canonical?: string;
  description?: string;
  keywords?: string;
  author?: string;

  /** If true: add robots noindex/nofollow */
  noindex?: boolean;

  /** OpenGraph / Twitter */
  ogTitle?: string;
  ogDescription?: string;
  ogImage?: string; // relative (/og/...) or absolute
  ogType?: 'website' | 'article';
  twitterCard?: 'summary' | 'summary_large_image';
  twitterSite?: string;

  bodyClass?: string;
  showNav?: boolean;
  showFooter?: boolean;
  scripts?: string[];
}

const {
  title = 'Minecraft Gilde',
  canonical,
  description,
  keywords,
  author = 'Christian Falkner',

  noindex = false,

  ogTitle,
  ogDescription,
  ogImage = '/og/og-default.jpg',
  ogType = 'website',
  twitterCard = 'summary_large_image',
  twitterSite,

  bodyClass = '',
  showNav = true,
  showFooter = true,
  scripts = [],
} = Astro.props as Props;

// Absolute URLs (important for OG/Twitter)
const site = Astro.site ?? new URL('https://minecraft-gilde.de');
const canonicalUrl = canonical ?? new URL(Astro.url.pathname, site).toString();

const metaTitle = title;
const metaDescription =
  description ??
  'Minecraft Gilde â€“ Langzeitwelt ohne Resets. Fair ohne Pay-to-Win. Vanilla+ Komfort.';

const finalOgTitle = ogTitle ?? metaTitle;
const finalOgDescription = ogDescription ?? metaDescription;

const finalOgImage = ogImage.startsWith('http') ? ogImage : new URL(ogImage, site).toString();
---

<!doctype html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="color-scheme" content="light dark" />

    <link rel="canonical" href={canonicalUrl} />
    <link rel="sitemap" href="/sitemap-index.xml" />

    <title>{metaTitle}</title>
    <meta name="description" content={metaDescription} />
    {keywords ? <meta name="keywords" content={keywords} /> : null}
    {author ? <meta name="author" content={author} /> : null}
    <meta name="robots" content={noindex ? 'noindex, nofollow' : 'index, follow'} />

    {/* Theme color (updated dynamically to match --bg) */}
    <meta name="theme-color" content="#0b0f14" />

    {/* Icons / PWA */}
    <link rel="icon" href="/favicon.ico" sizes="any" />
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180" />
    <link rel="manifest" href="/site.webmanifest" />

    {/* OpenGraph */}
    <meta property="og:locale" content="de_DE" />
    <meta property="og:type" content={ogType} />
    <meta property="og:site_name" content="Minecraft Gilde" />
    <meta property="og:title" content={finalOgTitle} />
    <meta property="og:description" content={finalOgDescription} />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:image" content={finalOgImage} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:image:alt" content="Minecraft Gilde" />

    {/* Twitter */}
    <meta name="twitter:card" content={twitterCard} />
    {twitterSite ? <meta name="twitter:site" content={twitterSite} /> : null}
    <meta name="twitter:title" content={finalOgTitle} />
    <meta name="twitter:description" content={finalOgDescription} />
    <meta name="twitter:image" content={finalOgImage} />

    <script is:inline>
      // Theme bootstrap (prevents flash). Values: 'light' | 'dark' | 'system'
      try {
        const stored = localStorage.getItem('theme');
        const root = document.documentElement;
        if (stored === 'light' || stored === 'dark') root.dataset.theme = stored;
        else root.removeAttribute('data-theme');
      } catch {
        // ignore
      }
    </script>

    <script is:inline>
      // Keep theme-color in sync with the active theme (uses CSS variable --bg)
      try {
        const meta = document.querySelector('meta[name="theme-color"]');
        const root = document.documentElement;

        const update = () => {
          const bg = getComputedStyle(root).getPropertyValue('--bg').trim();
          if (meta && bg) meta.setAttribute('content', bg);
        };

        // Initial update (after theme bootstrap above)
        update();

        // React to manual theme toggles (data-theme changes)
        const obs = new MutationObserver(update);
        obs.observe(root, { attributes: true, attributeFilter: ['data-theme'] });

        // React to system theme changes (when no manual override is set)
        const mq = window.matchMedia('(prefers-color-scheme: dark)');
        mq.addEventListener?.('change', update);

        window.addEventListener('DOMContentLoaded', update);
      } catch {
        // ignore
      }
    </script>

    <script is:inline>
      // Expose v2 config to JS (no sensitive data)
      window.__APP_CONFIG__ = {
        serverIp: 'minecraft-gilde.de',
        discordGuildId: '1219625244906754093',
        discordInvite: 'https://discord.minecraft-gilde.de',
        discordInviteCode: 'gCNfmWKFSp',
        dynmapUrl: 'https://map.minecraft-gilde.de',
      };
    </script>

    <slot name="head" />
  </head>

  <body class={`min-h-dvh flex flex-col bg-bg text-fg antialiased ${bodyClass}`.trim()}>
    <a
      href="#main"
      class="bg-surface-solid text-fg border-border sr-only rounded-lg border px-3 py-2 text-sm font-medium focus:not-sr-only focus:fixed focus:top-4 focus:left-4 focus:z-50"
    >
      Zum Inhalt springen
    </a>

    <div class="pointer-events-none fixed inset-0 -z-10 overflow-hidden">
      <div
        class="bg-accent/10 absolute top-[-14rem] left-1/2 h-[28rem] w-[28rem] -translate-x-1/2 rounded-full blur-3xl"
      >
      </div>
      <div
        class="bg-accent/5 absolute top-[10rem] right-[-12rem] h-[24rem] w-[24rem] rounded-full blur-3xl"
      >
      </div>
    </div>

    {showNav ? <Navbar /> : null}

    <main id="main" class="flex-1">
      <slot />
    </main>

    {showFooter ? <Footer /> : null}

    <div
      id="toast"
      class="pointer-events-none fixed bottom-4 left-1/2 z-[60] hidden -translate-x-1/2"
      aria-live="polite"
      aria-atomic="true"
    >
    </div>

    <script src="/js/app.js" defer></script>
    {scripts.map((src) => <script src={src} defer />)}
    <slot name="afterScripts" />
  </body>
</html>
