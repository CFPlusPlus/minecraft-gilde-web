---
import BaseLayout from '../layouts/BaseLayout.astro';
import Card from '../components/ui/Card.astro';
import {
  ChevronDown,
  Crown,
  Filter,
  ListOrdered,
  Search,
  Sparkles,
  Swords,
  X,
} from '@lucide/astro';
---

<BaseLayout
  title="Minecraft Gilde - Statistiken"
  canonical="https://minecraft-gilde.de/statistiken/"
  description="Live-Spielerstatistiken für Minecraft Gilde – Ranglisten, Server-König und Spielerübersicht."
  scripts={['/js/stats.js']}
>
  <link slot="head" rel="preconnect" href="https://minotar.net" crossorigin />
  <link slot="head" rel="dns-prefetch" href="//minotar.net" />

  <section class="mg-container pt-12 pb-12">
    <h1 class="text-3xl font-semibold tracking-tight">Statistiken</h1>
    <p class="text-muted mt-2 max-w-3xl">
      Suche nach Spielern, entdecke Ranglisten und sieh, wer aktuell die meisten Punkte sammelt. Die
      Daten werden serverseitig generiert und können leicht verzögert sein.
    </p>

    <Card class="relative z-30 mt-6 overflow-visible">
      <!-- Tabs -->
      <div
        aria-label="Statistik Tabs"
        role="tablist"
        class="border-border flex flex-wrap items-center gap-1 border-b px-4"
      >
        <button
          aria-controls="tab-uebersicht"
          class="tab-btn text-muted hover:border-border/60 hover:text-fg focus-visible:ring-offset-bg active text-fg border-accent -mb-px inline-flex items-center gap-2 border-b-2 border-transparent px-3 py-3 text-sm font-semibold transition-colors focus-visible:ring-2 focus-visible:ring-[color:var(--ring)] focus-visible:ring-offset-2"
          data-hash="uebersicht"
          data-tab="tab-uebersicht"
          role="tab"
          type="button"
        >
          <Sparkles size={16} /> Übersicht
        </button>
        <button
          aria-controls="tab-king"
          class="tab-btn text-muted hover:border-border/60 hover:text-fg focus-visible:ring-offset-bg -mb-px inline-flex items-center gap-2 border-b-2 border-transparent px-3 py-3 text-sm font-semibold transition-colors focus-visible:ring-2 focus-visible:ring-[color:var(--ring)] focus-visible:ring-offset-2"
          data-hash="king"
          data-tab="tab-king"
          role="tab"
          type="button"
        >
          <Crown size={16} /> Server-König
        </button>
        <button
          aria-controls="tab-ranglisten"
          class="tab-btn text-muted hover:border-border/60 hover:text-fg focus-visible:ring-offset-bg -mb-px inline-flex items-center gap-2 border-b-2 border-transparent px-3 py-3 text-sm font-semibold transition-colors focus-visible:ring-2 focus-visible:ring-[color:var(--ring)] focus-visible:ring-offset-2"
          data-hash="ranglisten"
          data-tab="tab-ranglisten"
          role="tab"
          type="button"
        >
          <ListOrdered size={16} /> Ranglisten
        </button>
        <button
          aria-controls="tab-versus"
          class="tab-btn text-muted hover:border-border/60 hover:text-fg focus-visible:ring-offset-bg -mb-px inline-flex items-center gap-2 border-b-2 border-transparent px-3 py-3 text-sm font-semibold transition-colors focus-visible:ring-2 focus-visible:ring-[color:var(--ring)] focus-visible:ring-offset-2"
          data-hash="versus"
          data-tab="tab-versus"
          role="tab"
          type="button"
        >
          <Swords size={16} /> Versus
        </button>
      </div>

      <!-- Controls -->
      <div class="p-4">
        <div class="grid gap-3 lg:grid-cols-[1fr_auto] lg:items-center">
          <div class="relative w-full lg:max-w-xl" id="main-search">
            <div
              class="bg-surface-solid/30 border-border flex items-center gap-2 rounded-[var(--radius)] border px-3 py-2"
            >
              <Search size={18} class="text-muted" />
              <input
                id="search-name"
                type="search"
                autocomplete="off"
                placeholder="Spieler suchen…"
                class="placeholder:text-muted/70 text-fg w-full bg-transparent text-sm outline-none"
              />
            </div>

            <!-- Autocomplete Dropdown -->
            <div
              id="autocomplete-container"
              class="border-border bg-surface-solid/95 absolute right-0 left-0 z-50 mt-2 hidden overflow-hidden rounded-[var(--radius)] border shadow-2xl backdrop-blur-2xl backdrop-saturate-150"
            >
              <ul id="autocomplete-list" class="max-h-72 overflow-auto"></ul>
            </div>
          </div>

          <div class="flex flex-wrap items-center gap-2 lg:justify-end">
            <span
              id="player-count"
              class="bg-surface border-border inline-flex items-center rounded-full border px-3 py-1 text-xs font-medium backdrop-blur-md"
              >Spieler: …</span
            >
            <span
              id="generated-ts"
              class="bg-surface border-border text-muted inline-flex items-center rounded-full border px-3 py-1 text-xs font-medium backdrop-blur-md"
              >Stand: …</span
            >

            <div
              class="bg-surface border-border inline-flex items-center gap-2 rounded-full border px-3 py-1 text-xs font-medium backdrop-blur-md"
            >
              <span class="text-muted">Einträge</span>

              <div class="relative">
                <!-- Hidden select keeps existing JS behaviour intact -->
                <select id="page-size" class="sr-only" aria-label="Einträge pro Seite">
                  <option value="10" selected>10</option>
                  <option value="25">25</option>
                  <option value="50">50</option>
                  <option value="100">100</option>
                </select>

                <button
                  id="page-size-trigger"
                  type="button"
                  aria-haspopup="listbox"
                  aria-expanded="false"
                  class="text-fg hover:bg-surface-solid/60 focus-visible:ring-offset-bg inline-flex items-center gap-1 rounded-full px-2 py-0 text-xs leading-none font-semibold transition-colors focus-visible:ring-2 focus-visible:ring-[color:var(--ring)] focus-visible:ring-offset-2"
                >
                  <span id="page-size-label">10</span>
                  <ChevronDown size={14} class="text-muted" aria-hidden="true" />
                </button>

                <div
                  id="page-size-menu"
                  role="listbox"
                  aria-label="Einträge pro Seite"
                  class="border-border bg-surface-solid/95 absolute top-full right-0 z-50 mt-2 hidden min-w-[96px] overflow-auto rounded-[var(--radius)] border shadow-2xl backdrop-blur-2xl backdrop-saturate-150"
                >
                  <button
                    type="button"
                    role="option"
                    class="page-size-opt text-fg/90 hover:!bg-accent/25 hover:!text-accent focus-visible:!bg-accent/25 w-full px-3 py-2 text-left text-xs font-semibold transition-colors"
                    data-value="10">10</button
                  >
                  <button
                    type="button"
                    role="option"
                    class="page-size-opt text-fg/90 hover:!bg-accent/25 hover:!text-accent focus-visible:!bg-accent/25 w-full px-3 py-2 text-left text-xs font-semibold transition-colors"
                    data-value="25">25</button
                  >
                  <button
                    type="button"
                    role="option"
                    class="page-size-opt text-fg/90 hover:!bg-accent/25 hover:!text-accent focus-visible:!bg-accent/25 w-full px-3 py-2 text-left text-xs font-semibold transition-colors"
                    data-value="50">50</button
                  >
                  <button
                    type="button"
                    role="option"
                    class="page-size-opt text-fg/90 hover:!bg-accent/25 hover:!text-accent focus-visible:!bg-accent/25 w-full px-3 py-2 text-left text-xs font-semibold transition-colors"
                    data-value="100">100</button
                  >
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- API-Fehler (z. B. wenn /api nicht erreichbar ist) -->
        <div
          id="api-error"
          class="bg-accent/10 border-accent/40 mt-4 flex hidden items-start gap-3 rounded-[var(--radius)] border px-4 py-3 text-sm"
          role="alert"
        >
          <div class="bg-accent mt-0.5 h-2 w-2 flex-none rounded-full" aria-hidden="true"></div>
          <span id="api-error-text" class="text-fg/90"></span>
        </div>
      </div>
    </Card>
  </section>

  <!-- PANELS -->
  <section aria-label="Übersicht" class="tab-panel" id="tab-uebersicht">
    <div class="mg-container pb-12">
      <div
        id="welcome-box"
        class="mg-callout relative mt-6 flex items-start gap-3"
        data-variant="info"
      >
        <div
          class="bg-accent/15 text-accent mt-0.5 flex h-9 w-9 items-center justify-center rounded-xl"
        >
          <Sparkles size={18} />
        </div>
        <div class="min-w-0 flex-1">
          <p class="text-fg font-semibold">Willkommen auf der Statistik-Seite!</p>
          <p class="text-muted mt-1 text-sm leading-relaxed">
            Nutze die Suche oben, um direkt zur Spielerstatistik zu springen. In den Ranglisten
            findest du die Top-Werte je Kategorie – von Spielzeit über Distanz bis zu Kreaturen.
          </p>
        </div>
        <button
          type="button"
          class="warning-close text-muted hover:text-fg -m-1 rounded-lg p-1 transition-colors"
          aria-label="Schließen"
        >
          <X size={18} />
        </button>
      </div>

      <div class="mt-8">
        <h2 class="text-xl font-semibold tracking-tight">
          Die Geschichte unserer Welt – in Zahlen
        </h2>
        <p class="text-muted mt-2 text-sm leading-relaxed">
          Von langen Reisen über gefährliche Nächte bis zu großen Projekten: Hier siehst du den Puls
          des Servers.
        </p>
      </div>

      <div aria-live="polite" class="mt-5 grid gap-3 sm:grid-cols-2 lg:grid-cols-4" id="kpi-grid">
      </div>
    </div>
  </section>

  <section aria-label="Server-König" class="tab-panel hidden" id="tab-king">
    <div class="mg-container pb-12">
      <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <h2 class="text-xl font-semibold tracking-tight">Server-König</h2>
          <p class="text-muted mt-1 text-sm">
            Punkte über alle Kategorien – für die Top 3 je Rangliste.
          </p>
        </div>

        <button
          id="king-info-toggle"
          type="button"
          aria-controls="king-info-box"
          aria-expanded="true"
          class="bg-surface border-border hover:bg-surface-solid/70 text-fg inline-flex items-center gap-2 rounded-lg border px-3 py-2 text-sm font-semibold shadow-sm backdrop-blur-md transition-colors"
        >
          <Crown size={16} />
          <span id="king-info-toggle-label">Info zur Berechnung anzeigen</span>
        </button>
      </div>

      <div
        id="king-info-box"
        role="note"
        aria-label="Informationen zur Berechnung des Server-Königs"
        class="mg-callout mt-4 flex items-start gap-3"
        data-variant="info"
      >
        <div
          class="bg-accent/15 text-accent mt-0.5 flex h-9 w-9 items-center justify-center rounded-xl"
        >
          <Crown size={18} />
        </div>
        <div class="min-w-0 flex-1">
          <p class="text-fg font-semibold">So wird der Server-König berechnet</p>
          <p class="text-muted mt-1 text-sm leading-relaxed">
            Für jede Rangliste werden Punkte vergeben: <strong class="text-fg">1. Platz = 5</strong
            >,
            <strong class="text-fg">2. Platz = 3</strong>, <strong class="text-fg"
              >3. Platz = 1</strong
            >. Ab Platz 4 gibt es keine Punkte. Die Punkte werden über alle Kategorien addiert.
          </p>
        </div>
        <button
          id="king-info-close"
          type="button"
          class="text-muted hover:text-fg -m-1 rounded-lg p-1 transition-colors"
          aria-label="Schließen"
        >
          <X size={18} />
        </button>
      </div>

      <Card class="relative mt-5 overflow-x-auto">
        <table id="tbl-king" class="w-full min-w-[520px] text-sm">
          <caption class="text-muted px-4 py-3 text-left text-xs font-medium">
            Rangliste – Server-König
          </caption>
          <thead class="bg-surface-solid/40 text-muted text-xs">
            <tr>
              <th class="px-4 py-3 text-left font-semibold">Platz</th>
              <th class="px-4 py-3 text-left font-semibold">Spielername</th>
              <th class="px-4 py-3 text-left font-semibold">Punkte</th>
            </tr>
          </thead>
          <tbody
            class="divide-border [&>tr:hover]:bg-surface-solid/40 divide-y [&>tr>td]:px-4 [&>tr>td]:py-3"
          ></tbody>
        </table>

        <div class="border-border flex items-center justify-between gap-3 border-t px-4 py-3">
          <div id="king-pagination" class="w-full" aria-label="Seiten"></div>
        </div>
      </Card>
    </div>
  </section>

  <section aria-label="Ranglisten" class="tab-panel hidden" id="tab-ranglisten">
    <div class="mg-container pb-12">
      <Card class="p-5">
        <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
          <div>
            <h2 class="text-xl font-semibold tracking-tight">Ranglisten</h2>
            <p class="text-muted mt-1 text-sm">Öffne eine Rangliste, um die Tabelle zu laden.</p>
          </div>

          <div class="w-full sm:max-w-md">
            <div
              class="bg-surface-solid/30 border-border flex items-center gap-2 rounded-[var(--radius)] border px-3 py-2"
            >
              <Filter size={18} class="text-muted" />
              <input
                id="metric-filter"
                type="search"
                placeholder="Kategorien/Ranglisten filtern…"
                class="placeholder:text-muted/70 text-fg w-full bg-transparent text-sm outline-none"
              />
            </div>
          </div>
        </div>

        <div id="ranglisten-note" class="text-muted mt-4 text-sm">
          Tipp: Nutze die Spielersuche oben, um direkt zur persönlichen Statistik zu springen.
        </div>
      </Card>

      <div
        id="no-results-warning"
        class="bg-accent/10 border-accent/40 mt-3 flex hidden items-start gap-3 rounded-[var(--radius)] border px-4 py-3 text-sm"
        role="status"
      >
        <div class="bg-accent mt-0.5 h-2 w-2 flex-none rounded-full" aria-hidden="true"></div>
        <span class="text-fg/90">Keine Ranglisten gefunden.</span>
      </div>

      <div aria-live="polite" class="mt-5 space-y-4" id="metrics-container"></div>
    </div>
  </section>

  <section aria-label="Versus" class="tab-panel hidden" id="tab-versus">
    <div class="mg-container pb-12">
      <Card class="p-5">
        <p class="text-fg font-semibold">Versus</p>
        <p class="text-muted mt-1 text-sm">
          Geplant, wird aber erst in einem späteren Schritt umgesetzt.
        </p>
      </Card>
    </div>
  </section>
</BaseLayout>
